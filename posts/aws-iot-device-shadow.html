<!DOCTYPE html><html lang="zh-TW" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Hands-On Practice: AWS IoT Device Shadow | Kevin Liu's 部落格 || Technical || Travel</title><meta name="author" content="Kevin Liu"><meta name="copyright" content="Kevin Liu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Intro - What is AWS IoT Device Shadow?In real world, sometime it is difficult to get the actual device state in real time in such IoT scenarios. A device shadow can overcome this challenge, Device Sha">
<meta property="og:type" content="article">
<meta property="og:title" content="Hands-On Practice: AWS IoT Device Shadow">
<meta property="og:url" content="https://leozzmc.github.io/posts/aws-iot-device-shadow.html">
<meta property="og:site_name" content="Kevin Liu&#39;s 部落格 || Technical || Travel">
<meta property="og:description" content="Intro - What is AWS IoT Device Shadow?In real world, sometime it is difficult to get the actual device state in real time in such IoT scenarios. A device shadow can overcome this challenge, Device Sha">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://leozzmc.github.io/img/pepe_shadow.jpg">
<meta property="article:published_time" content="2023-11-08T08:30:18.000Z">
<meta property="article:modified_time" content="2025-10-26T12:28:30.486Z">
<meta property="article:author" content="Kevin Liu">
<meta property="article:tag" content="AWS">
<meta property="article:tag" content="IoT Core">
<meta property="article:tag" content="IoT Shadow">
<meta property="article:tag" content="MQTT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://leozzmc.github.io/img/pepe_shadow.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Hands-On Practice: AWS IoT Device Shadow",
  "url": "https://leozzmc.github.io/posts/aws-iot-device-shadow.html",
  "image": "https://leozzmc.github.io/img/pepe_shadow.jpg",
  "datePublished": "2023-11-08T08:30:18.000Z",
  "dateModified": "2025-10-26T12:28:30.486Z",
  "author": [
    {
      "@type": "Person",
      "name": "Kevin Liu",
      "url": "https://leozzmc.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/kevin3.png"><link rel="canonical" href="https://leozzmc.github.io/posts/aws-iot-device-shadow.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-T4SFRRLLZ0"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-T4SFRRLLZ0')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-T4SFRRLLZ0', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":3,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '複製成功',
    error: '複製失敗',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '載入更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Hands-On Practice: AWS IoT Device Shadow',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg" style="background-color: #f5f1ed;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/me.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">183</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">119</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 找文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 歸檔</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 鏈結</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 語言:</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/pepe_shadow.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://i.imgur.com/P19VCm0.png" alt="Logo"><span class="site-name">Kevin Liu's 部落格 || Technical || Travel</span></a><a class="nav-page-title" href="/"><span class="site-name">Hands-On Practice: AWS IoT Device Shadow</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首頁</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 找文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 歸檔</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 鏈結</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 語言:</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/en/"><i class="fa-fw fas fa-e"></i><span> English</span></a></li><li><a class="site-page child" href="/"><i class="fa-fw fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Hands-On Practice: AWS IoT Device Shadow</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2023-11-08T08:30:18.000Z" title="發表於 2023-11-08 16:30:18">2023-11-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2025-10-26T12:28:30.486Z" title="更新於 2025-10-26 20:28:30">2025-10-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AF%A6%E4%BD%9C%E7%B4%80%E9%8C%84/">實作紀錄</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">瀏覽量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Intro-What-is-AWS-IoT-Device-Shadow"><a href="#Intro-What-is-AWS-IoT-Device-Shadow" class="headerlink" title="Intro - What is AWS IoT Device Shadow?"></a>Intro - What is AWS IoT Device Shadow?</h1><p>In real world, sometime it is difficult to get the actual device state in real time in such IoT scenarios.</p>
<p>A device shadow can overcome this challenge, Device Shadow can consider a virtual  virtual representation of a device which managed by the <strong>IoT Things</strong> resource created in AWS IoT Core.</p>
<blockquote>
<p>The Shadow document is a JSON or a JavaScript notation doc that is used to store and retrieve the current state information for a device. You can use the shadow to get and set the state of a device over MQTT topics or HTTP REST APIs, regardless of whether the device is connected to the internet.</p>
</blockquote>
<h1 id="Shadow-Document"><a href="#Shadow-Document" class="headerlink" title="Shadow Document"></a>Shadow Document</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;delta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Refer to the json above, you can check there 3 <strong>state</strong> properties in shadow document.</p>
<ul>
<li>desired<ul>
<li>Apps specify the desired states of device properties by updating the desired object</li>
</ul>
</li>
<li>reported<ul>
<li>Devices report their current state in the reported object.</li>
</ul>
</li>
<li>delta<ul>
<li>AWS IoT reports differences between the desired and the reported state in the delta object.</li>
</ul>
</li>
</ul>
<blockquote>
<p>You can consider the flow of Shadow a finite state machine, for AWS IoT Core, it will also check if there are delta event, that means there difference between <strong>Desired</strong> and <strong>Reported</strong> states</p>
</blockquote>
<p>So how can we update the state of a shadow?  The answer is clear,</p>
<blockquote>
<p><strong>By subscribing&#x2F;publishing messages to the certain MQTT topics</strong></p>
</blockquote>
<h1 id="Shadow-Topic"><a href="#Shadow-Topic" class="headerlink" title="Shadow Topic"></a>Shadow Topic</h1><table>
<thead>
<tr>
<th>ShadowTopicPrefix value</th>
<th>Shadow type</th>
</tr>
</thead>
<tbody><tr>
<td>$aws&#x2F;things&#x2F;<code>thingName</code>&#x2F;shadow</td>
<td>Unnamed (classic) shadow</td>
</tr>
<tr>
<td>$aws&#x2F;things&#x2F;<code>thingName</code>&#x2F;shadow&#x2F;name&#x2F;shadowName</td>
<td>Named shadow</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Client operations allowed</th>
</tr>
</thead>
<tbody><tr>
<td><code>ShadowTopicPrefix</code>&#x2F;delete</td>
<td>Publish&#x2F;Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;delete&#x2F;accepted</td>
<td>Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;delete&#x2F;rejected</td>
<td>Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;get</td>
<td>Publish&#x2F;Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;get&#x2F;accepted</td>
<td>Publish&#x2F;Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;get&#x2F;rejected</td>
<td>Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;update</td>
<td>Publish&#x2F;Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;accepted</td>
<td>Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;rejected</td>
<td>Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;delta</td>
<td>Subscribe</td>
</tr>
<tr>
<td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;documents</td>
<td>Subscribe</td>
</tr>
</tbody></table>
<blockquote>
<p>For detail explanation about these shadow topics, see the documentation - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/device-shadow-mqtt.html">https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/device-shadow-mqtt.html</a></p>
</blockquote>
<h1 id="The-state-changes-of-Device-Shadow"><a href="#The-state-changes-of-Device-Shadow" class="headerlink" title="The state changes of Device Shadow"></a>The state changes of Device Shadow</h1><p><img src="https://i.imgur.com/l071JEc.png" alt="Imgur"></p>
<p>Take this picture for example, the update flow is:</p>
<ol>
<li>The MQTT client publishes a <code>$aws/things/myLightBulb/shadow/update</code> message to the server. The message carries the desired state <code>&#123;&quot;state&quot;: &#123;&quot;desired&quot;:&#123;&quot;color&quot;:&quot;green&quot;&#125;&#125;&#125;</code></li>
<li>IoT Server responds with <code>$aws/things/myLightBulb/shadow/accepted</code>, indicating that the update message has been received. At the same time, it publishes <code>$aws/things/myLightBulb/shadow/delta</code> to notify the device to update, and then publishes <code>$aws/things/myLightBulb/shadow/update/document</code> as update record</li>
<li>After receiving the message, the Device performs the corresponding update operation and publishes a message <code>$aws/things/myLightBulb/shadow/update</code> <code>&#123;&quot;state&quot;&#123;&quot;report&quot;:&#123;&quot;color&quot;:&quot;green&quot;&#125;&#125;&#125;</code> to the IoT Server after completion. Notification updated</li>
<li>After receiving the post-update message, IoT Server responds with <code>$aws/things/myLightBulb/shadow/accepted</code> to indicate that the update message has been received. Publish another <code>$aws/things/myLightBulb/shadow/update/document</code> as an update record</li>
</ol>
<h1 id="Expermient-for-IoT-Shadow"><a href="#Expermient-for-IoT-Shadow" class="headerlink" title="Expermient for IoT Shadow"></a>Expermient for IoT Shadow</h1><h2 id="Device-Setup"><a href="#Device-Setup" class="headerlink" title="Device Setup"></a>Device Setup</h2><p>Since I don’t have any IoT Device currently available, I simulate the device by launching a EC2 instance.</p>
<ul>
<li>AMI: <code>Ubuntu 22 LTS</code></li>
<li>Type: <code>t2.Micro</code></li>
<li>Subnet: <code>10.1.0.0/24</code></li>
</ul>
<p>Then connect to the EC2 instance by using SSH, and run the following command</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y python3-pip</span><br><span class="line">mkdir certs/</span><br></pre></td></tr></table></figure>

<h2 id="Setup-in-AWS-IoT-Core"><a href="#Setup-in-AWS-IoT-Core" class="headerlink" title="Setup in AWS IoT Core"></a>Setup in AWS IoT Core</h2><p>There are 3 things to setup in AWS IoT Core</p>
<ul>
<li>Create certificate</li>
<li>Create IoT Policy and associated with the certificate</li>
<li>Create Things object and associate with the certificate</li>
</ul>
<h3 id="Things"><a href="#Things" class="headerlink" title="Things"></a>Things</h3><p>This is a thing named <code>ESP32</code> for testing purposes, it have associated with the certificate</p>
<p><img src="https://i.imgur.com/96y4cVz.png" alt="Imgur"></p>
<h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>And this certificate has issued by the Amazon Root CA.</p>
<p><img src="https://i.imgur.com/Hg9Jzsv.png" alt="Imgur"></p>
<p>And there are IoT Policy - <code>TestPolicy</code> asccociate with this certificate.</p>
<p><em>TestPolicy</em></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Publish&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/get&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Receive&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/get/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/get/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update/delta&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Subscribe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/get/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:rus-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/get/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/update/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/update/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/update/delta&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Connect&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>Remember, this policy must have adequate permissions for <code>CONNECT</code>, <code>SUBSCRIBE</code>, <code>Publish</code> and <code>Publish</code><br>to the Shadow topic.</p>
<p>Once you have setup these stuff, now I need to convey the certificate to the EC2 instance.</p>
<p><img src="https://i.imgur.com/LKSyMJw.png" alt="Imgur"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i &lt;SSH KEY&gt; TestDeviceShadow/*    ubuntu@ec2-&lt;EC2 Public Address&gt;.compute-1.amazonaws.com:/home/ubuntu/certs</span><br></pre></td></tr></table></figure>

<p>Apart from the device certificate, it is necessary to provide the CA certificate in the device.</p>
<ul>
<li>Download the CA Cert in the device</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd certs/</span><br><span class="line">curl -o ~/certs/Amazon-root-CA-1.pem \</span><br><span class="line">    https://www.amazontrust.com/repository/AmazonRootCA1.pem </span><br></pre></td></tr></table></figure>

<p>Now there all credential we need to test the IoT Device Shadows</p>
<h2 id="Install-the-IoT-Core-Python-Device-SDK"><a href="#Install-the-IoT-Core-Python-Device-SDK" class="headerlink" title="Install the IoT Core Python Device SDK"></a>Install the IoT Core Python Device SDK</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/aws/aws-iot-device-sdk-python-v2.git</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s/__version__ = &#x27;1.0.0-dev&#x27;/__version__ = &#x27;&lt;SDK_VERSION&gt;&#x27;/&quot; \</span><br><span class="line">  aws-iot-device-sdk-python-v2/awsiot/__init__.py</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install ./aws-iot-device-sdk-python-v2</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ~/aws-iot-device-sdk-python-v2/samples</span><br></pre></td></tr></table></figure>

<h2 id="Execute-the-shadow-py"><a href="#Execute-the-shadow-py" class="headerlink" title="Execute the shadow.py"></a>Execute the shadow.py</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 shadow.py --ca_file ~/certs/Amazon-root-CA-1.pem --cert ~/certs/device.pem.crt --key ~/certs/private.pem.key --endpoint your-iot-endpoint --thing_name your-iot-thing-name</span><br></pre></td></tr></table></figure>

<blockquote>
<p>You can derive the iot endpoint by checking the AWS IoT Console<br>Find the <strong>Connect</strong> &gt; <strong>Connect One Device</strong> in the left pane<br>Scroll down and you will see the IoT endpoint</p>
</blockquote>
<p><img src="https://i.imgur.com/mDBpV7l.png" alt="Imgur"></p>
<p>Back to the script, after you execute the <code>shadow.py</code>, you will see the prompt in your terminal</p>
<p><img src="https://i.imgur.com/necUKaZ.png" alt="Imgur"></p>
<p>You will need to enter the desired value. So I enter “yellow”.</p>
<p><img src="https://i.imgur.com/CQOkk83.png" alt="Imgur"></p>
<p>Then you can observe that the state changed to “yellow”. This results may also observe from the AWS IoT Console</p>
<blockquote>
<p>Go to Things, and select your thing object, on the bottem of the target thing page, you can navigate to the <strong>Device Shadow</strong> tab, then select the <strong>Classic Shadow</strong>, then you can see the Device Shadow State below</p>
</blockquote>
<p><img src="https://i.imgur.com/KTfooA1.png" alt="Imgur"></p>
<p><img src="https://i.imgur.com/Xcu4BKk.png" alt="Imgur"></p>
<p>For testing, I enter “green” as the input of <code>shadow.py</code>.</p>
<p>And the state change show in both terminal and IoT Console</p>
<p><img src="https://i.imgur.com/AEEMMCa.png" alt="Imgur"></p>
<p><img src="https://i.imgur.com/BWi4UZh.png" alt="Imgur"></p>
<h2 id="Test-the-Shadow-Document"><a href="#Test-the-Shadow-Document" class="headerlink" title="Test the Shadow Document"></a>Test the Shadow Document</h2><p>Now you can try to edit the Shadow Document directly.</p>
<p>For example, I change the desired state from red to green.</p>
<p>Then you will notice that the change will reflect to the <strong>Delta report</strong>.</p>
<p><img src="https://i.imgur.com/9l40PXT.png" alt="Imgur"></p>
<h2 id="Test-with-AWS-IoT-Test-MQTT-Client"><a href="#Test-with-AWS-IoT-Test-MQTT-Client" class="headerlink" title="Test with AWS IoT Test MQTT Client"></a>Test with AWS IoT Test MQTT Client</h2><p>First, it is necessary to subscribe to the shadow topic in the MQTT client, for receiving the state change events.</p>
<p><img src="https://i.imgur.com/Zq4x4i8.png" alt="Imgur"></p>
<p>The client can subscribe to the topic</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$aws/things/ESP32/shadow/update/#</span><br></pre></td></tr></table></figure>
<p>The wildcard symbol <strong>“#”</strong> indicates that it wants to subscribe all topic under the <code>update/</code> prefix.</p>
<p>And you can re-run the program with new color value. You can find the MQTT client will receive the state change events.</p>
<p>At first, the color was “red”.</p>
<blockquote>
<p>The message published to $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;document topic</p>
</blockquote>
<p>Then it changed to “green”.</p>
<blockquote>
<p> The message published to $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;accepted topic<br>Noted that any unsuccessful messages were received on the topic $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;rejected </p>
</blockquote>
<p><img src="https://i.imgur.com/brQ3knq.png" alt="Imgur"></p>
<h2 id="Edit-the-shadow-document-again"><a href="#Edit-the-shadow-document-again" class="headerlink" title="Edit the shadow document again"></a>Edit the shadow document again</h2><p>I change the desired stat value “blue” to “black”.</p>
<p><img src="https://i.imgur.com/DVKi6Xb.png" alt="Imgur"></p>
<p>The first received event will be on the delta topic, it means that there are differences between desired state and reported state.</p>
<p>At the same time, the message will published to the topic $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;accepted for notifying the device to update the state</p>
<p><img src="https://i.imgur.com/7fewMie.png" alt="Imgur"></p>
<p>And also published to the shadow document topic for recording.</p>
<p><img src="https://i.imgur.com/FYULN43.png" alt="Imgur"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;previous&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699430576</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699430576</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;black&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699431256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699431256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">21</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699431256</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>But the reported state is not “Black”.</p>
<p>you can see the event published to the accepted topic.</p>
<p><img src="https://i.imgur.com/pzVidVy.png" alt="Imgur"></p>
<p>Meanwhile, the message published to the document topic</p>
<p><img src="https://i.imgur.com/ZKmF0vG.png" alt="Imgur"></p>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>You will found the state change from <strong>(Desired: “Blue”, Reported: “Blue”)</strong> to <strong>(Desired: “Black”, Reported: “Blue”)</strong> and the final state is <strong>(Desired: “Black”, Reported: “Black”)</strong>.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[+] Create a virtual device with Amazon EC2 - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/iot/latest/developerguide/creating-a-virtual-thing.html">https://docs.aws.amazon.com/iot/latest/developerguide/creating-a-virtual-thing.html</a><br>[+] Tutorial: Provisioning your device in AWS IoT - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/iot/latest/developerguide/shadow-provision-cloud.html">https://docs.aws.amazon.com/iot/latest/developerguide/shadow-provision-cloud.html</a><br>[+] Tutorial: Installing the Device SDK and running the sample application for Device Shadows - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/iot/latest/developerguide/lightbulb-shadow-application.html">https://docs.aws.amazon.com/iot/latest/developerguide/lightbulb-shadow-application.html</a><br>[+] Tutorial: Interacting with Device Shadow using the sample app and the MQTT test client - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/iot/latest/developerguide/interact-lights-device-shadows.html">https://docs.aws.amazon.com/iot/latest/developerguide/interact-lights-device-shadows.html</a><br>[+] Reserved topics - Shadow topics - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/iot/latest/developerguide/reserved-topics.html#reserved-topics-shadow">https://docs.aws.amazon.com/iot/latest/developerguide/reserved-topics.html#reserved-topics-shadow</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://leozzmc.github.io">Kevin Liu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章連結: </span><span class="post-copyright-info"><a href="https://leozzmc.github.io/posts/aws-iot-device-shadow.html">https://leozzmc.github.io/posts/aws-iot-device-shadow.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 授權協議。轉載請註明來源 <a href="https://leozzmc.github.io" target="_blank">Kevin Liu's 部落格 || Technical || Travel</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AWS/">AWS</a><a class="post-meta__tags" href="/tags/IoT-Core/">IoT Core</a><a class="post-meta__tags" href="/tags/IoT-Shadow/">IoT Shadow</a><a class="post-meta__tags" href="/tags/MQTT/">MQTT</a></div><div class="post-share"><div class="social-share" data-image="/img/pepe_shadow.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/efc78ef4.html" title="Hands-On Practice: Amazon SNS Fan out to Amazon SQS"><img class="cover" src="/img/pepe5.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Hands-On Practice: Amazon SNS Fan out to Amazon SQS</div></div><div class="info-2"><div class="info-item-1">IntroductionAmazon SNS offen works well with Amazon SQS, by subscribing SQS to SNS, the SNS service can push messages to SQS. This may eliminating the need to periodically check or “poll” for updates. What is Amazon SQS?By official definition  Amazon SQS is a message queue service used by distributed applications to exchange messages through a polling model, and can be used to decouple sending ...</div></div></div></a><a class="pagination-related" href="/posts/889a40ef.html" title="機群佈建(Fleet Provisioning) - 預先佈建裝置到 AWS IoT"><img class="cover" src="/img/OIG.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">機群佈建(Fleet Provisioning) - 預先佈建裝置到 AWS IoT</div></div><div class="info-2"><div class="info-item-1">簡介什麼是機群佈建(Fleet Provisioning)?機群佈建當中也有分成 要求佈建 （Provisioning by Claim） 還有 透過信任的使用者佈建 （Provisioning by Trusted User） 要求佈建裝置可以使用內嵌的佈建宣告憑證（Claim Certificate）(這是特殊用途的憑證) 和私有金鑰  來製造。如果這些憑證已向 AWS IoT 註冊，該服務可以將它們交換為裝置可用於一般操作的唯一裝置憑證。 透過信任的使用者佈建在許多情況下，如終端使用者或安裝技術人員等信任的使用者初次使用行動應用程式在其部署的位置設定裝置時，裝置會連線至 AWS IoT  在本篇文章中，主要會介紹透過 要求佈建 的方式來去進行機群佈建  要求佈建的流程 設置 - AWS IoT Core建立憑證以及公私鑰對產生用於佈建的憑證。  可以在 AWS IoT Cons...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相關推薦</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/889a40ef.html" title="機群佈建(Fleet Provisioning) - 預先佈建裝置到 AWS IoT"><img class="cover" src="/img/OIG.jpeg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="info-item-2">機群佈建(Fleet Provisioning) - 預先佈建裝置到 AWS IoT</div></div><div class="info-2"><div class="info-item-1">簡介什麼是機群佈建(Fleet Provisioning)?機群佈建當中也有分成 要求佈建 （Provisioning by Claim） 還有 透過信任的使用者佈建 （Provisioning by Trusted User） 要求佈建裝置可以使用內嵌的佈建宣告憑證（Claim Certificate）(這是特殊用途的憑證) 和私有金鑰  來製造。如果這些憑證已向 AWS IoT 註冊，該服務可以將它們交換為裝置可用於一般操作的唯一裝置憑證。 透過信任的使用者佈建在許多情況下，如終端使用者或安裝技術人員等信任的使用者初次使用行動應用程式在其部署的位置設定裝置時，裝置會連線至 AWS IoT  在本篇文章中，主要會介紹透過 要求佈建 的方式來去進行機群佈建  要求佈建的流程 設置 - AWS IoT Core建立憑證以及公私鑰對產生用於佈建的憑證。  可以在 AWS IoT Cons...</div></div></div></a><a class="pagination-related" href="/posts/c0ef3a5f.html" title="近一年半的 AWS Cloud Support Engineer 心得記錄"><img class="cover" src="/img/AWS/CSE/aws3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-03</div><div class="info-item-2">近一年半的 AWS Cloud Support Engineer 心得記錄</div></div><div class="info-2"><div class="info-item-1">背景 目前在台灣亞馬遜網路服務公司 (Amazon Web Services) 擔任 雲端支援工程師 (Cloud Support Engineer) ，但兩天後就要離職了，因此想說趁離職前紀錄並回顧一下這一年半以來的工作以及生活。  我是在我碩二上的時候(2021年10月)投遞AWS Cloud Support 校園招聘的職缺，當時原本在找研發替代役，後來因為知道AWS有開缺，抱持著試試看的心情投遞了履歷。大概隔天就收到了Online Assessment 的通知。OA其實就是簡單的電腦基礎知識，應該只是拿來篩本科非本科的(?)，接著就是Phone Interview，當時的校招可以排志願序，我原本想去的是 Security 或者 Deployment Profile，但我在面試過程中，發現問題大多會跟 Troubleshooting 相關，因此Security Fail了，然後D...</div></div></div></a><a class="pagination-related" href="/posts/dce71546.html" title="DevOps技能樹知識整理 |【筆記目錄】"><img class="cover" src="/img/devops/cover3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2060-11-05</div><div class="info-item-2">DevOps技能樹知識整理 |【筆記目錄】</div></div><div class="info-2"><div class="info-item-1">前言這裡紀錄 DevOps 面試常見的知識點，主要是參考了這個 github repository: DevOps Exercises 和 ByteByteGo 的 GitHub Repo 所做的筆記整理  可能會花很久時間才能夠全部整理完成~  DevOps GeneralPython Basic Data Types OOP &#x2F; Class Raise Exceptions Regex Async File Manipulation OS lambda decorator Flask   文章： Python for DevOps |【DevOps技能樹】  Networking TCP&#x2F;UDP OSI Model CIDR Mac Addr. CSMA&#x2F;CD NAT DNS ICMP TLS&#x2F;SSL Handshake Route Tab...</div></div></div></a><a class="pagination-related" href="/posts/c79cef2b.html" title="Lambda 基本認識 feat.容器重用小實驗"><img class="cover" src="/img/PEPE1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-16</div><div class="info-item-2">Lambda 基本認識 feat.容器重用小實驗</div></div><div class="info-2"><div class="info-item-1">前言首先，為什麼談到無伺服器總是會有人提到 Lambda ? 以下就開始來介紹這個服務 FaaS (Function as a Service)一旦談到無伺服器運算，就會提到他的核心概念，功能即服務(Function as a Service) ，這裡引用維基百科對於 FaaS 的解釋  FaaS 是雲端運算的一種模型。以平台即服務（PaaS）為基礎，無伺服器運算提供一個微型的架構，終端客戶不需要部署、配置或管理伺服器服務，程式碼運行所需要的伺服器服務皆由雲端平台來提供。  沒錯，這個概念的核心就是讓使用者專注在設計產品或業務邏輯，而不需費心在部署配置或是設定伺服器。 而最早實踐這個概念並推出服務的，就是 AWS 在 2014 年推出的 Lambda 服務。（當然後續也有 Microsoft 的 Azure Function） Lambda 函數 Lambda 在高可用性的運算基礎設...</div></div></div></a><a class="pagination-related" href="/posts/f40d2e89.html" title="Lambda_layer 概念和實作"><img class="cover" src="/img/pepe3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-20</div><div class="info-item-2">Lambda_layer 概念和實作</div></div><div class="info-2"><div class="info-item-1">前言針對 Lambda 設定，絕大多數人一定碰過 ImportModuleError  所以各位可以跟著以下的情境，開一個一樣的 Lambda 環境逐步操作。 情境 Region: IAD(us-east-1) Runtime: Python3.11 Lambda Name: “ITHomeLambdaFunction” Lambda code1234567891011import json requestsdef lambda_handler(event, context):    # TODO implement    x = requests.get(&#x27;https://www.ntust.edu.tw/&#x27;)    print(x.text)    return &#123;        &#x27;statusCode&#x27;: 200,       ...</div></div></div></a><a class="pagination-related" href="/posts/421a206a.html" title="建立 Lambda 函數 URL 的步驟"><img class="cover" src="/img/AWS/Lambda_URL/cover.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-03</div><div class="info-item-2">建立 Lambda 函數 URL 的步驟</div></div><div class="info-2"><div class="info-item-1">甚麼是 Lambda URL ? 官方定義: 函數 URL 是 Lambda 函數專用的 HTTP(S) 端點。您可以透過 Lambda 主控台或 Lambda API 建立及設定函數 URL。當您建立函數 URL 時，Lambda 會自動為您產生不重複的 URL 端點。函數 URL 一旦建立，其 URL 端點便永遠不會變更。  函數 URL 端點的格式如下： 1https://&lt;url-id&gt;.lambda-url.&lt;region&gt;.on.aws  要特別注意的是，某些region並不支援使用 function URL，這時可能就要用老方法: API Gateway + Lambda Integration 存取控制在建立 function URL 的時候可以透過 AuthType 參數，來決定 Lambda 如何對 funcion URL 的請求執行身分驗...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div id="utterances-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/me.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Kevin Liu</div><div class="author-info-description">👍👍👍👍👍</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">183</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">119</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/leozzmc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/leozzmc" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:zzmczzmczzmc870125@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #e0ad5a;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/kevin-liu087" target="_blank" title="LinkedIn"><i class="fa-brands fa-linkedin" style="color: #0373fc;"></i></a><a class="social-icon" href="https://www.youtube.com/channel/UC2AU_vpxPu0oKcgZl3UJSNg" target="_blank" title="Youtube"><i class="fa-brands fa-youtube" style="color: #dc1e1e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">🛫🛬</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Intro-What-is-AWS-IoT-Device-Shadow"><span class="toc-number">1.</span> <span class="toc-text">Intro - What is AWS IoT Device Shadow?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shadow-Document"><span class="toc-number">2.</span> <span class="toc-text">Shadow Document</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shadow-Topic"><span class="toc-number">3.</span> <span class="toc-text">Shadow Topic</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-state-changes-of-Device-Shadow"><span class="toc-number">4.</span> <span class="toc-text">The state changes of Device Shadow</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Expermient-for-IoT-Shadow"><span class="toc-number">5.</span> <span class="toc-text">Expermient for IoT Shadow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Device-Setup"><span class="toc-number">5.1.</span> <span class="toc-text">Device Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setup-in-AWS-IoT-Core"><span class="toc-number">5.2.</span> <span class="toc-text">Setup in AWS IoT Core</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Things"><span class="toc-number">5.2.1.</span> <span class="toc-text">Things</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Certificate"><span class="toc-number">5.2.2.</span> <span class="toc-text">Certificate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Install-the-IoT-Core-Python-Device-SDK"><span class="toc-number">5.3.</span> <span class="toc-text">Install the IoT Core Python Device SDK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Execute-the-shadow-py"><span class="toc-number">5.4.</span> <span class="toc-text">Execute the shadow.py</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-the-Shadow-Document"><span class="toc-number">5.5.</span> <span class="toc-text">Test the Shadow Document</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-with-AWS-IoT-Test-MQTT-Client"><span class="toc-number">5.6.</span> <span class="toc-text">Test with AWS IoT Test MQTT Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Edit-the-shadow-document-again"><span class="toc-number">5.7.</span> <span class="toc-text">Edit the shadow document again</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusions"><span class="toc-number">5.8.</span> <span class="toc-text">Conclusions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">5.9.</span> <span class="toc-text">References</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/d0fc136d.html" title="LeetCode 刷題知識總整理">LeetCode 刷題知識總整理</a><time datetime="2100-11-29T01:08:02.000Z" title="發表於 2100-11-29 09:08:02">2100-11-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/dce71546.html" title="DevOps技能樹知識整理 |【筆記目錄】"><img src="/img/devops/cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DevOps技能樹知識整理 |【筆記目錄】"/></a><div class="content"><a class="title" href="/posts/dce71546.html" title="DevOps技能樹知識整理 |【筆記目錄】">DevOps技能樹知識整理 |【筆記目錄】</a><time datetime="2060-11-05T13:45:50.000Z" title="發表於 2060-11-05 21:45:50">2060-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/22911275.html" title="Git for DevOps 筆記 |【DevOps技能樹】"><img src="/img/devops/git/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git for DevOps 筆記 |【DevOps技能樹】"/></a><div class="content"><a class="title" href="/posts/22911275.html" title="Git for DevOps 筆記 |【DevOps技能樹】">Git for DevOps 筆記 |【DevOps技能樹】</a><time datetime="2025-11-11T03:45:46.000Z" title="發表於 2025-11-11 11:45:46">2025-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/85addf17.html" title="合法括號字串 | Medium | LeetCode#678. Valid Parenthesis String"><img src="/img/LeetCode/678/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="合法括號字串 | Medium | LeetCode#678. Valid Parenthesis String"/></a><div class="content"><a class="title" href="/posts/85addf17.html" title="合法括號字串 | Medium | LeetCode#678. Valid Parenthesis String">合法括號字串 | Medium | LeetCode#678. Valid Parenthesis String</a><time datetime="2025-10-26T07:05:24.000Z" title="發表於 2025-10-26 15:05:24">2025-10-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8a835d3b.html" title="Pow(x, n) | Medium | LeetCode#50. Pow(x, n)"><img src="/img/LeetCode/50/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Pow(x, n) | Medium | LeetCode#50. Pow(x, n)"/></a><div class="content"><a class="title" href="/posts/8a835d3b.html" title="Pow(x, n) | Medium | LeetCode#50. Pow(x, n)">Pow(x, n) | Medium | LeetCode#50. Pow(x, n)</a><time datetime="2025-10-23T06:03:36.000Z" title="發表於 2025-10-23 14:03:36">2025-10-23</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2019 - 2025 By Kevin Liu</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="繁簡轉換">EN</button><button id="darkmode" type="button" title="日夜模式切換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂端"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'dark'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null
  const getUtterancesTheme = theme => theme === 'dark' ? 'photon-dark' : 'github-light'

  const loadUtterances = (el = document, key) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyUtterances = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const config = {
      src: 'https://utteranc.es/client.js',
      repo: 'leozzmc/Blog_Reply',
      theme: getUtterancesTheme(document.documentElement.getAttribute('data-theme')),
      crossorigin: 'anonymous',
      async: true,
      ...option,
      'issue-term': isShuoshuo ? key : (option && option['issue-term']) || 'pathname'
    }

    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => ele.setAttribute(key, value))
    el.querySelector('#utterances-wrap').appendChild(ele)
  }

  const changeUtterancesTheme = theme => {
    const iframe = document.querySelector('#utterances-wrap iframe')
    if (iframe) {
      const message = {
        type: 'set-theme',
        theme: getUtterancesTheme(theme)
      };
      iframe.contentWindow.postMessage(message, 'https://utteranc.es')
    }
  }

  btf.addGlobalFn('themeChange', changeUtterancesTheme, 'utterances')

  if (isShuoshuo) {
    'Utterances' === 'Utterances'
      ? window.shuoshuoComment = { loadComment: loadUtterances }
      : window.loadOtherComment = loadUtterances
    return
  }
  
  if ('Utterances' === 'Utterances' || !false) {
    if (false) btf.loadComment(document.getElementById('utterances-wrap'), loadUtterances)
    else loadUtterances()
  } else {
    window.loadOtherComment = loadUtterances
  }
})()</script></div><script data-pjax src="/self/btf.js"></script><script data-pjax src="/self/tw_en.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script data-pjax src="/self/calendar.js"></script><script data-pjax src="/self/languages.js"></script><script id="canvas_nest" defer="defer" color="34,34,34" opacity="0.8" zIndex="-1" count="350" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>